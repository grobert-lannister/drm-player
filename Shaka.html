<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Test Player (Shaka + ClearKey)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Shaka Player (usa una versione recente) -->
  <!-- Esempio da unpkg: -->
  <script src="https://unpkg.com/shaka-player@latest/dist/shaka-player.compiled.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b0b; color:#f3f3f3; margin:0; padding:24px; }
    .wrap { max-width: 900px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; }
    video { width: 100%; height: 384px; background:#000; }
    input, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid #a4166a55; background:#111; color:#fff; }
    textarea { min-height: 96px; }
    button { padding:10px 14px; border:0; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    .hint { font-size:12px; color:#c6c6c6; }
    .err { color:#ff7b7b; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok  { color:#7bffa1; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    label { font-size:14px; color:#e9e9e9; display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <video id="video" controls></video>

    <div>
      <label for="mpd">MPD URL</label>
      <input id="mpd" type="text" placeholder="https://esempio.tld/path/manifest.mpd" />
      <div class="hint">Inserisci l’URL MPD/DASH.</div>
    </div>

    <div class="row">
      <div>
        <label for="kids">KIDs (uno per riga)</label>
        <textarea id="kids" placeholder="kid1-esadecimale-32-byte&#10;kid2-esadecimale-32-byte"></textarea>
      </div>
      <div>
        <label for="keys">Keys (una per riga, nello stesso ordine dei KIDs)</label>
        <textarea id="keys" placeholder="key1-esadecimale-16-byte&#10;key2-esadecimale-16-byte"></textarea>
      </div>
    </div>

    <div>
      <label for="headers">Headers richiesta (uno per riga, tipo <kbd>Header-Name: value</kbd>)</label>
      <textarea id="headers" placeholder="Authorization: Bearer xxx&#10;X-Custom: foo"></textarea>
      <div class="hint">Se servono header per scaricare il manifest/segmenti. Verranno aggiunti via Shaka NetworkingEngine.</div>
    </div>

    <div class="row">
      <button id="playBtn">Submit</button>
      <button id="destroyBtn">Reset Player</button>
    </div>

    <div id="log" class="hint"></div>
  </div>

  <script>
    // Helpers
    function parseHeaders(text) {
      const out = {};
      text.split(/\r?\n/).forEach(line => {
        const idx = line.indexOf(':');
        if (idx > 0) {
          const k = line.slice(0, idx).trim();
          const v = line.slice(idx + 1).trim();
          if (k) out[k] = v;
        }
      });
      return out;
    }

    function lines(text) {
      return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    // Stato semplice
    let player = null;

    async function initPlayer() {
      // Carica polyfills Shaka
      shaka.polyfill.installAll();

      const video = document.getElementById('video');
      if (player) return player;

      player = new shaka.Player(video);

      // Log errori
      player.addEventListener('error', ev => {
        const e = ev.detail;
        log('Errore Shaka: code=' + e.code + '\n' + JSON.stringify(e, null, 2), true);
      });

      return player;
    }

    function addRequestHeaders(player, headersObj) {
      const net = player.getNetworkingEngine();
      // Rimuovi filtri precedenti (per semplicità)
      net.clearAllRequestFilters?.();

      // Aggiungi un filtro che setta gli header sulle richieste media/manifest
      net.registerRequestFilter((type, request) => {
        // Applica a tutto (manifest, segmenti, licenze se servisse)
        request.headers = Object.assign({}, request.headers || {}, headersObj);
      });
    }

    async function onSubmit() {
      const mpdUrl    = document.getElementById('mpd').value.trim();
      const kidsTxt   = document.getElementById('kids').value;
      const keysTxt   = document.getElementById('keys').value;
      const headersTxt= document.getElementById('headers').value;

      if (!mpdUrl) { log('MPD URL è obbligatorio', true); return; }

      const kidsArr = lines(kidsTxt);
      const keysArr = lines(keysTxt);

      if (kidsArr.length === 0 || keysArr.length === 0) {
        log('KIDs e Keys sono obbligatorie (una per riga).', true); return;
      }
      if (kidsArr.length !== keysArr.length) {
        log(`Il numero di KIDs (${kidsArr.length}) deve coincidere con quello delle Keys (${keysArr.length}).`, true);
        return;
      }

      // Mappa ClearKey: { kid: key }
      const clearKeys = {};
      kidsArr.forEach((kid, i) => {
        clearKeys[kid] = keysArr[i];
      });

      const cfg = { drm: { clearKeys } };

      try {
        const p = await initPlayer();

        // Headers opzionali
        const hdrs = parseHeaders(headersTxt);
        if (Object.keys(hdrs).length) {
          addRequestHeaders(p, hdrs);
        } else {
          // Se vuoto, assicurati che non restino vecchi filtri
          p.getNetworkingEngine().clearAllRequestFilters?.();
        }

        // Configura ClearKey e carica
        p.configure(cfg);
        await p.load(mpdUrl);
        log('Video caricato con successo.\nConfig DRM: ' + JSON.stringify(cfg, null, 2));
      } catch (err) {
        console.error(err);
        log('Errore durante il load:\n' + (err && err.message ? err.message : String(err)), true);
      }
    }

    function onDestroy() {
      if (player) {
        player.destroy().catch(()=>{}).finally(() => {
          player = null;
          const video = document.getElementById('video');
          video.removeAttribute('src');
          video.load();
          log('Player resettato.');
        });
      } else {
        log('Nessun player attivo.');
      }
    }

    function log(msg, isErr = false) {
      const el = document.getElementById('log');
      el.className = isErr ? 'err' : 'ok';
      el.textContent = msg;
    }

    // Wire-up
    document.getElementById('playBtn').addEventListener('click', onSubmit);
    document.getElementById('destroyBtn').addEventListener('click', onDestroy);

    // Init lazy (opzionale)
    window.addEventListener('load', initPlayer);
  </script>
  <script>
  // Attiva log verbosi
  shaka.log.setLevel(shaka.log.Level.DEBUG);

  function explainError(e) {
    // e è shaka.util.Error
    const cat = e.category;    // numerico
    const code = e.code;       // numerico
    const sev = e.severity;    // numerico
    const data = e.data || []; // array con dettagli (es. status, uri, ecc.)

    // mappe rapide per leggibilità
    const C = shaka.util.Error.Category;
    const S = shaka.util.Error.Severity;
    const categoryName = Object.keys(C).find(k => C[k] === cat) || cat;
    const severityName = Object.keys(S).find(k => S[k] === sev) || sev;

    return {
      severity: severityName,
      category: categoryName,
      code,
      data
    };
  }

  async function initPlayerWithBetterErrors(videoEl) {
    const p = new shaka.Player(videoEl);

    p.addEventListener('error', (ev) => {
      const info = explainError(ev.detail);
      console.error('Shaka ERROR:', info);
      const maybeStatus = info.data.find(d => typeof d === 'number' && d >= 100 && d < 600);
      const maybeUrl    = info.data.find(d => typeof d === 'string' && /^https?:/.test(d));
      let hint = '';

      if (info.category === 'NETWORK') {
        // Indizi rapidi
        if (maybeStatus === 404) hint = 'Manifest/segmento non trovato (404). Controlla l’URL.';
        else if (maybeStatus === 401 || maybeStatus === 403) hint = 'Auth/permessi (401/403). Aggiungi gli header corretti.';
        else if (!maybeStatus) hint = 'CORS/CSP o rete bloccata. Controlla console e header CORS/CSP.';
      } else if (info.category === 'MANIFEST') {
        hint = 'MPD non valido o non leggibile. Verifica XML/Content-Type e accesso.';
      } else if (info.category === 'DRM') {
        hint = 'ClearKey non coerenti con il contenuto (KID/key, formato o lunghezza errati).';
      } else if (info.category === 'MEDIA') {
        hint = 'Codec/containers non supportati, o segments corrotti.';
      }

      const msg = [
        `Shaka Error ${info.code} [${info.category}/${info.severity}]`,
        maybeUrl ? `URL: ${maybeUrl}` : '',
        maybeStatus ? `HTTP status: ${maybeStatus}` : '',
        hint
      ].filter(Boolean).join('\n');

      const logEl = document.getElementById('log');
      if (logEl) { logEl.className = 'err'; logEl.textContent = msg; }
    });

    return p;
  }

  // Usa questa funzione al posto di initPlayer()
  async function initPlayer() {
    shaka.polyfill.installAll();
    const video = document.getElementById('video');
    if (!window.__player) {
      window.__player = await initPlayerWithBetterErrors(video);
    }
    return window.__player;
  }
</script>

</body>
</html>
